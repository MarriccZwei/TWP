from ...C4.Geometry.CatiaParser import CatiaParser
from ...C4.Geometry.Mesher import Mesher

import numpy as np
import pyvista as pv

def test_adaptive_mesh():
    meshout = "sq;0.04981928571444759;0.0699999989952564$0.1329999997733663$-2.0605739337042904e-16,0.06761480212084806$0.1329999997733663$0.01811732860227524,0.07044721739124671$0.12$0.01887626684496368,0.07293232972697336$0.11999999999999975$2.4965579825675377e-10|sq;0.04981928571444759;0.06761480212084806$0.1329999997733663$0.01811732860227524,0.06062177005547362$0.1329999997733663$0.03499999019176284,0.06316124494801774$0.12$0.036466152116766064,0.07044721739124671$0.12$0.01887626684496368|sq;0.04981928571444759;0.06062177005547362$0.1329999997733663$0.03499999019176284,0.049497466188090325$0.1329999997733663$0.04949745973919201,0.0515709392402544$0.12$0.0515709285771859,0.06316124494801774$0.12$0.036466152116766064|sq;0.04981928571444759;0.049497466188090325$0.1329999997733663$0.04949745973919201,0.03499999314160485$0.1329999997733663$0.06062175904651661,0.03646616022789124$0.12$0.06316123095919185,0.0515709392402544$0.12$0.0515709285771859|sq;0.04981928571444759;0.03499999314160485$0.1329999997733663$0.06062175904651661,0.018117329352518172$0.1329999997733663$0.0676147858015903,0.018876273351869928$0.12$0.07044719952949449,0.03646616022789124$0.12$0.06316123095919185|sq;0.04981742857162283;0.018117329352518172$0.1329999997733663$0.0676147858015903,-1.5631940186722203e-16$0.1329999997733663$0.06999997697734389,5.3264592294092686e-17$0.12519999990934652$0.07175937541637399,0.018876273351869928$0.12$0.07044719952949449|sq;0.04981742857162283;-1.5631940186722203e-16$0.1329999997733663$0.06999997697734389,-0.018117329352518453$0.1329999997733663$0.06761478580159022,-0.01887627335187001$0.12$0.07044719952949446,5.3264592294092686e-17$0.12519999990934652$0.07175937541637399|sq;0.04981928571444759;-0.018117329352518453$0.1329999997733663$0.06761478580159022,-0.034999993141605124$0.1329999997733663$0.060621759046516434,-0.03646616022789126$0.12$0.06316123095919184,-0.01887627335187001$0.12$0.07044719952949446|sq;0.04981928571444759;-0.034999993141605124$0.1329999997733663$0.060621759046516434,-0.04949746618809055$0.1329999997733663$0.04949745973919178,-0.051570939240254514$0.12$0.05157092857718577,-0.03646616022789126$0.12$0.06316123095919184|sq;0.04981928571444759;-0.04949746618809055$0.1329999997733663$0.04949745973919178,-0.06062177005547375$0.1329999997733663$0.03499999019176258,-0.06316124494801778$0.12$0.03646615211676597,-0.051570939240254514$0.12$0.05157092857718577|sq;0.04981928571444759;-0.06062177005547375$0.1329999997733663$0.03499999019176258,-0.06761480212084812$0.1329999997733663$0.018117328602274944,-0.07044721739124676$0.12$0.018876266844963522,-0.06316124494801778$0.12$0.03646615211676597|sq;0.04981928571444759;-0.06761480212084812$0.1329999997733663$0.018117328602274944,-0.06999999899525639$0.1329999997733663$-5.258016244624741e-16,-0.07293232972697333$0.11999999999999975$2.4965545009081326e-10,-0.07044721739124676$0.12$0.018876266844963522|sq;0.04984285714285714;0.07293232972697336$0.11999999999999975$2.4965579825675377e-10,0.07044721739124671$0.12$0.01887626684496368,0.07365324367999532$0.1$0.023931381888336337,0.07744360785441533$0.09999999999999976$5.281181856275907e-10|sq;0.04984285714285714;0.07044721739124671$0.12$0.01887626684496368,0.06316124494801774$0.12$0.036466152116766064,0.06265318884637215$0.1$0.04552019684018914,0.07365324367999532$0.1$0.023931381888336337|sq;0.04984285714285714;0.06316124494801774$0.12$0.036466152116766064,0.0515709392402544$0.12$0.0515709285771859,0.045520205063177464$0.1$0.06265317685105824,0.06265318884637215$0.1$0.04552019684018914|sq;0.04984285714285714;0.0515709392402544$0.12$0.0515709285771859,0.03646616022789124$0.12$0.06316123095919185,0.02393138768934235$0.1$0.07365322693127399,0.045520205063177464$0.1$0.06265317685105824|sq;0.04984285714285714;0.03646616022789124$0.12$0.06316123095919185,0.018876273351869928$0.12$0.07044719952949449,-1.1862785937066295e-17$0.1$0.07744358583650258,0.02393138768934235$0.1$0.07365322693127399|sq;0.04983385714288953;0.018876273351869928$0.12$0.07044719952949449,5.3264592294092686e-17$0.12519999990934652$0.07175937541637399,-0.01887627335187001$0.12$0.07044719952949446,-1.1862785937066295e-17$0.1$0.07744358583650258|sq;0.04984285714285714;-0.01887627335187001$0.12$0.07044719952949446,-0.03646616022789126$0.12$0.06316123095919184,-0.0239313876893425$0.1$0.07365322693127394,-1.1862785937066295e-17$0.1$0.07744358583650258|sq;0.04984285714285714;-0.03646616022789126$0.12$0.06316123095919184,-0.051570939240254514$0.12$0.05157092857718577,-0.04552020506317748$0.1$0.06265317685105823,-0.0239313876893425$0.1$0.07365322693127394|sq;0.04984285714285714;-0.051570939240254514$0.12$0.05157092857718577,-0.06316124494801778$0.12$0.03646615211676597,-0.06265318884637223$0.1$0.04552019684018899,-0.04552020506317748$0.1$0.06265317685105823|sq;0.04984285714285714;-0.06316124494801778$0.12$0.03646615211676597,-0.07044721739124676$0.12$0.018876266844963522,-0.07365324367999532$0.1$0.023931381888336302,-0.06265318884637223$0.1$0.04552019684018899|sq;0.04984285714285714;-0.07044721739124676$0.12$0.018876266844963522,-0.07293232972697333$0.11999999999999975$2.4965545009081326e-10,-0.07744360785441531$0.09999999999999976$5.281179227267785e-10,-0.07365324367999532$0.1$0.023931381888336302|sq;0.049871428571428573;0.07744360785441533$0.09999999999999976$5.281181856275907e-10,0.07365324367999532$0.1$0.023931381888336337,0.07794372389436398$0.08$0.025325444251807414,0.08195488598185735$0.07999999999999975$6.78551906219127e-10|sq;0.049871428571428573;0.07365324367999532$0.1$0.023931381888336337,0.06265318884637215$0.1$0.04552019684018914,0.06630288916752004$0.08$0.048171860074641866,0.07794372389436398$0.08$0.025325444251807414|sq;0.049871428571428573;0.06265318884637215$0.1$0.04552019684018914,0.045520205063177464$0.1$0.06265317685105824,0.04817186749404211$0.08$0.06630287775604708,0.06630288916752004$0.08$0.048171860074641866|sq;0.049871428571428573;0.045520205063177464$0.1$0.06265317685105824,0.02393138768934235$0.1$0.07365322693127399,0.02532544910813899$0.08$0.07794370745258604,0.04817186749404211$0.08$0.06630287775604708|sq;0.049871428571428573;0.02393138768934235$0.1$0.07365322693127399,-1.1862785937066295e-17$0.1$0.07744358583650258,-1.5854885263697879e-16$0.08$0.08195486396394444,0.02532544910813899$0.08$0.07794370745258604|sq;0.049871428571428573;-1.1862785937066295e-17$0.1$0.07744358583650258,-0.0239313876893425$0.1$0.07365322693127394,-0.025325449108139154$0.08$0.07794370745258598,-1.5854885263697879e-16$0.08$0.08195486396394444|sq;0.049871428571428573;-0.0239313876893425$0.1$0.07365322693127394,-0.04552020506317748$0.1$0.06265317685105823,-0.04817186749404225$0.08$0.06630287775604699,-0.025325449108139154$0.08$0.07794370745258598|sq;0.049871428571428573;-0.04552020506317748$0.1$0.06265317685105823,-0.06265318884637223$0.1$0.04552019684018899,-0.06630288916752011$0.08$0.048171860074641776,-0.04817186749404225$0.08$0.06630287775604699|sq;0.049871428571428573;-0.06265318884637223$0.1$0.04552019684018899,-0.07365324367999532$0.1$0.023931381888336302,-0.07794372389436398$0.08$0.025325444251807314,-0.06630288916752011$0.08$0.048171860074641776|sq;0.049871428571428573;-0.07365324367999532$0.1$0.023931381888336302,-0.07744360785441531$0.09999999999999976$5.281179227267785e-10,-0.08195488598185732$0.07999999999999977$6.785517001617336e-10,-0.07794372389436398$0.08$0.025325444251807314|sq;0.0499;0.08195488598185735$0.07999999999999975$6.78551906219127e-10,0.07794372389436398$0.08$0.025325444251807414,0.08223420410873268$0.06$0.026719506615278287,0.08646616410929936$0.059999999999999803$7.009569316096531e-10|sq;0.0499;0.07794372389436398$0.08$0.025325444251807414,0.06630288916752004$0.08$0.048171860074641866,0.06995258948866799$0.06$0.05082352330909453,0.08223420410873268$0.06$0.026719506615278287|sq;0.0499;0.06630288916752004$0.08$0.048171860074641866,0.04817186749404211$0.08$0.06630287775604708,0.05082352992490695$0.06$0.06995257866103578,0.06995258948866799$0.06$0.05082352330909453|sq;0.0499;0.04817186749404211$0.08$0.06630287775604708,0.02532544910813899$0.08$0.07794370745258604,0.026719510526935716$0.06$0.08223418797389807,0.05082352992490695$0.06$0.06995257866103578|sq;0.04989714285714286;0.02532544910813899$0.08$0.07794370745258604,-1.5854885263697879e-16$0.08$0.08195486396394444,-1.3630697079093546e-17$0.068$0.08466163084040958,0.026719510526935716$0.06$0.08223418797389807|sq;0.04989714285714286;-1.5854885263697879e-16$0.08$0.08195486396394444,-0.025325449108139154$0.08$0.07794370745258598,-0.026719510526935736$0.06$0.08223418797389805,-1.3630697079093546e-17$0.068$0.08466163084040958|sq;0.0499;-0.025325449108139154$0.08$0.07794370745258598,-0.04817186749404225$0.08$0.06630287775604699,-0.05082352992490691$0.06$0.06995257866103581,-0.026719510526935736$0.06$0.08223418797389805|sq;0.0499;-0.04817186749404225$0.08$0.06630287775604699,-0.06630288916752011$0.08$0.048171860074641776,-0.06995258948866796$0.06$0.05082352330909456,-0.05082352992490691$0.06$0.06995257866103581|sq;0.0499;-0.06630288916752011$0.08$0.048171860074641776,-0.07794372389436398$0.08$0.025325444251807314,-0.08223420410873265$0.06$0.02671950661527832,-0.06995258948866796$0.06$0.05082352330909456|sq;0.0499;-0.07794372389436398$0.08$0.025325444251807314,-0.08195488598185732$0.07999999999999977$6.785517001617336e-10,-0.08646616410929935$0.059999999999999803$7.009567397631145e-10,-0.08223420410873265$0.06$0.02671950661527832|sq;0.04992142857142857;0.08646616410929936$0.059999999999999803$7.009569316096531e-10,0.08223420410873268$0.06$0.026719506615278287,0.08196825243234769$0.05$0.03395235568173265,0.08872180317302036$0.04999999999999983$6.641486223202264e-10|sq;0.04992142857142857;0.08223420410873268$0.06$0.026719506615278287,0.06995258948866799$0.06$0.05082352330909453,0.0627357817561859$0.05$0.0627357735513831,0.08196825243234769$0.05$0.03395235568173265|sq;0.04992142857142857;0.06995258948866799$0.06$0.05082352330909453,0.05082352992490695$0.06$0.06995257866103578,0.03395235965194692$0.05$0.08196823789003571,0.0627357817561859$0.05$0.0627357735513831|sq;0.04992142857142857;0.05082352992490695$0.06$0.06995257866103578,0.026719510526935716$0.06$0.08223418797389807,6.417564383867744e-17$0.05$0.08872178115510723,0.03395235965194692$0.05$0.08196823789003571|sq;0.049914999999999994;0.026719510526935716$0.06$0.08223418797389807,-1.3630697079093546e-17$0.068$0.08466163084040958,-0.026719510526935736$0.06$0.08223418797389805,6.417564383867744e-17$0.05$0.08872178115510723|sq;0.04992142857142857;-0.026719510526935736$0.06$0.08223418797389805,-0.05082352992490691$0.06$0.06995257866103581,-0.03395235965194688$0.05$0.08196823789003571,6.417564383867744e-17$0.05$0.08872178115510723|sq;0.04992142857142857;-0.05082352992490691$0.06$0.06995257866103581,-0.06995258948866796$0.06$0.05082352330909456,-0.06273578175618585$0.05$0.06273577355138313,-0.03395235965194688$0.05$0.08196823789003571|sq;0.04992142857142857;-0.06995258948866796$0.06$0.05082352330909456,-0.08223420410873265$0.06$0.02671950661527832,-0.08196825243234769$0.05$0.03395235568173261,-0.06273578175618585$0.05$0.06273577355138313|sq;0.04992142857142857;-0.08223420410873265$0.06$0.02671950661527832,-0.08646616410929935$0.059999999999999803$7.009567397631145e-10,-0.08872180317302035$0.04999999999999983$6.64148494422534e-10,-0.08196825243234769$0.05$0.03395235568173261|sq;0.04994285714285715;0.08872180317302036$0.04999999999999983$6.641486223202264e-10,0.08196825243234769$0.05$0.03395235568173265,0.08613612967467052$0.03$0.03567874776815539,0.0932330813004624$0.029999999999999874$4.945105658293869e-10|sq;0.04994285714285715;0.08196825243234769$0.05$0.03395235568173265,0.0627357817561859$0.05$0.0627357735513831,0.06592573676073772$0.03$0.06592572925829661,0.08613612967467052$0.03$0.03567874776815539|sq;0.04994285714285715;0.0627357817561859$0.05$0.0627357735513831,0.03395235965194692$0.05$0.08196823789003571,0.03567875082068998$0.03$0.08613611551247394,0.06592573676073772$0.03$0.06592572925829661|sq;0.04994285714285715;0.03395235965194692$0.05$0.08196823789003571,6.417564383867744e-17$0.05$0.08872178115510723,-1.5730091560250897e-17$0.03$0.0932330592825491,0.03567875082068998$0.03$0.08613611551247394|sq;0.04994285714285715;6.417564383867744e-17$0.05$0.08872178115510723,-0.03395235965194688$0.05$0.08196823789003571,-0.035678750820689865$0.03$0.08613611551247398,-1.5730091560250897e-17$0.03$0.0932330592825491|sq;0.04994285714285715;-0.03395235965194688$0.05$0.08196823789003571,-0.06273578175618585$0.05$0.06273577355138313,-0.06592573676073761$0.03$0.0659257292582967,-0.035678750820689865$0.03$0.08613611551247398|sq;0.04994285714285715;-0.06273578175618585$0.05$0.06273577355138313,-0.08196825243234769$0.05$0.03395235568173261,-0.08613612967467049$0.03$0.03567874776815543,-0.06592573676073761$0.03$0.0659257292582967|sq;0.04994285714285715;-0.08196825243234769$0.05$0.03395235568173261,-0.08872180317302035$0.04999999999999983$6.64148494422534e-10,-0.0932330813004624$0.029999999999999874$4.945104805642586e-10,-0.08613612967467049$0.03$0.03567874776815543|sq;0.049971428571428576;0.0932330813004624$0.029999999999999874$4.945105658293869e-10,0.08613612967467052$0.03$0.03567874776815539,0.09030400691699328$0.01$0.037405139854578204,0.09774435942790444$0.00999999999999995$1.968438070321099e-10|sq;0.049971428571428576;0.08613612967467052$0.03$0.03567874776815539,0.06592573676073772$0.03$0.06592572925829661,0.06911569176528963$0.01$0.06911568496521008,0.09030400691699328$0.01$0.037405139854578204|sq;0.049971428571428576;0.06592573676073772$0.03$0.06592572925829661,0.03567875082068998$0.03$0.08613611551247394,0.037405141989432976$0.01$0.0903039931349122,0.06911569176528963$0.01$0.06911568496521008|sq;0.049971428571428576;0.03567875082068998$0.03$0.08613611551247394,-1.5730091560250897e-17$0.03$0.0932330592825491,-1.6835036024017928e-17$0.01$0.09774433740999097,0.037405141989432976$0.01$0.0903039931349122|sq;0.049971428571428576;-1.5730091560250897e-17$0.03$0.0932330592825491,-0.035678750820689865$0.03$0.08613611551247398,-0.03740514198943293$0.01$0.09030399313491222,-1.6835036024017928e-17$0.01$0.09774433740999097|sq;0.049971428571428576;-0.035678750820689865$0.03$0.08613611551247398,-0.06592573676073761$0.03$0.0659257292582967,-0.0691156917652895$0.01$0.06911568496521017,-0.03740514198943293$0.01$0.09030399313491222|sq;0.049971428571428576;-0.06592573676073761$0.03$0.0659257292582967,-0.08613612967467049$0.03$0.03567874776815543,-0.09030400691699325$0.01$0.037405139854578245,-0.0691156917652895$0.01$0.06911568496521017|sq;0.049971428571428576;-0.08613612967467049$0.03$0.03567874776815543,-0.0932330813004624$0.029999999999999874$4.945104805642586e-10,-0.09774435942790442$0.00999999999999995$1.9684376439954575e-10,-0.09030400691699325$0.01$0.037405139854578245|sq;0.04999285714285714;0.09774435942790444$0.00999999999999995$1.968438070321099e-10,0.09030400691699328$0.01$0.037405139854578204,0.09238794553815467$-1.1074474670659005e-17$0.03826833589778965,0.0999999984916255$-1.1074474670659e-17$-3.907985046680551e-16|sq;0.04999285714285714;0.09030400691699328$0.01$0.037405139854578204,0.06911569176528963$0.01$0.06911568496521008,0.07071066926756549$-1.107447467065901e-17$0.07071066281866689,0.09238794553815467$-1.1074474670659005e-17$0.03826833589778965|sq;0.04999285714285714;0.06911569176528963$0.01$0.06911568496521008,0.037405141989432976$0.01$0.0903039931349122,0.03826833757380453$-1.1074474670659011e-17$0.09238793194613132,0.07071066926756549$-1.107447467065901e-17$0.07071066281866689|sq;0.04999285714285714;0.037405141989432976$0.01$0.0903039931349122,-1.6835036024017928e-17$0.01$0.09774433740999097,2.1316282072803006e-17$-1.1074474670659011e-17$0.09999997647371191,0.03826833757380453$-1.1074474670659011e-17$0.09238793194613132|sq;0.04999285714285714;-1.6835036024017928e-17$0.01$0.09774433740999097,-0.03740514198943293$0.01$0.09030399313491222,-0.038268337573804496$-1.1074474670659011e-17$0.09238793194613132,2.1316282072803006e-17$-1.1074474670659011e-17$0.09999997647371191|sq;0.04999285714285714;-0.03740514198943293$0.01$0.09030399313491222,-0.0691156917652895$0.01$0.06911568496521017,-0.07071066926756543$-1.1074474670659008e-17$0.07071066281866693,-0.038268337573804496$-1.1074474670659011e-17$0.09238793194613132|sq;0.04999285714285714;-0.0691156917652895$0.01$0.06911568496521017,-0.09030400691699325$0.01$0.037405139854578245,-0.09238794553815463$-1.1074474670659005e-17$0.03826833589778966,-0.07071066926756543$-1.1074474670659008e-17$0.07071066281866693|sq;0.04999285714285714;-0.09030400691699325$0.01$0.037405139854578245,-0.09774435942790442$0.00999999999999995$1.9684376439954575e-10,-0.09999999849162544$-1.1074474670658999e-17$-3.552713678800501e-16,-0.09238794553815463$-1.1074474670659005e-17$0.03826833589778966"

    collisionDecimalPlaces=3
    parsed = CatiaParser(meshout)
    mesher = Mesher(collisionDecimalPlaces)
    for eleType, eleArgs, eleNodes in parsed.get_mesh_data():
        mesher.load_ele(eleNodes, eleType, eleArgs)

    ncoords = np.array(mesher.nodes)

    #quads
    cells = list()
    for quad in mesher.eleNodePoses:
        #print(quad.n3)
        cells.append([4, quad[0], quad[1], quad[2], quad[3]])
    cells = np.array(cells).flatten()

    cell_types = np.full(len(mesher.eleNodePoses), pv.CellType.QUAD)
    mesh = pv.UnstructuredGrid(cells, cell_types, ncoords)

    plotter = pv.Plotter()
    
    plotter.add_mesh(
        mesh,
        show_edges=True,
        color="lightblue",
        edge_color="black"
    )

    plotter.show()


if __name__=="__main__":
    test_adaptive_mesh()